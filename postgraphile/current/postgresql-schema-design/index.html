<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-4.x plugin-docs plugin-id-default docs-doc-id-postgresql-schema-design">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">PostgreSQL Schema Design | PostGraphile</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://postgraphile.org/postgraphile/current/postgresql-schema-design"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="4.x"><meta data-rh="true" name="docusaurus_tag" content="docs-default-4.x"><meta data-rh="true" name="docsearch:version" content="4.x"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-4.x"><meta data-rh="true" property="og:title" content="PostgreSQL Schema Design | PostGraphile"><meta data-rh="true" name="description" content="The Postgres database is rich with features well beyond that of any other"><meta data-rh="true" property="og:description" content="The Postgres database is rich with features well beyond that of any other"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://postgraphile.org/postgraphile/current/postgresql-schema-design"><link data-rh="true" rel="alternate" href="https://postgraphile.org/postgraphile/current/postgresql-schema-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://postgraphile.org/postgraphile/current/postgresql-schema-design" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://T47OLMXAXW-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="PostGraphile" href="/opensearch.xml">

<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="PostGraphile RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="PostGraphile Atom Feed">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sarabun"><link rel="stylesheet" href="/assets/css/styles.b5934424.css">
<link rel="preload" href="/assets/js/runtime~main.80bf8250.js" as="script">
<link rel="preload" href="/assets/js/main.4f3a8e0c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_G6ar" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_ncOr" role="banner"><div class="content_L1uV announcementBarContent__57G">This documentation is a work in progress, please forgive gaps, and feel free to send pull requests!</div></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="PostGraphile Logo" class="themedImage_RWGG themedImage--light_riBm"><img src="/img/logo.svg" alt="PostGraphile Logo" class="themedImage_RWGG themedImage--dark_Dsi0"></div><b class="navbar__title text--truncate">PostGraphile</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/postgraphile/current/">Documentation</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/postgraphile/current/">4.x</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/postgraphile/next/postgresql-schema-design">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/postgraphile/current/postgresql-schema-design">4.x</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/news">News</a><a class="navbar__item navbar__link" href="/sponsor">Sponsor</a><a class="navbar__item navbar__link" href="/pricing">Go Pro</a><a href="https://www.graphile.org/support/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_awgD"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/graphile/crystal" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_awgD"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_OLSw colorModeToggle_Hg9V"><button class="clean-btn toggleButton_wYmb toggleButtonDisabled_vaDU" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_Sxwe"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_Yem1"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_xrOJ"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_UyTV docsWrapper_BqXd"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_z1FD" type="button"></button><div class="docPage_pOTq"><aside class="theme-doc-sidebar-container docSidebarContainer_aIKW"><div class="sidebarViewport_DwR9"><div class="sidebar_vJCc"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_qiME menuWithAnnouncementBar_hRfJ"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><h4>OVERVIEW</h4></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/postgraphile/current/examples/">Example Gallery</a><button aria-label="Toggle the collapsible sidebar category &#x27;Example Gallery&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/postgraphile/current/usage">Usage</a><button aria-label="Toggle the collapsible sidebar category &#x27;Usage&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/performance">Performance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/requirements">Requirements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/required-knowledge">Required Knowledge</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><h4>OPERATION</h4></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/quick-start-guide">Quick Start Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/namespaces">Namespaces (PostgreSQL &quot;schemas&quot;)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/inflection">Inflection</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/postgraphile/current/tables">Tables</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tables&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/postgraphile/current/functions">Functions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Functions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/enums">Enums</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/views">Views</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/aggregates">Aggregates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/postgresql-indexes">PostgreSQL Indexes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/security">Security</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/postgraphile/current/realtime">Realtime</a><button aria-label="Toggle the collapsible sidebar category &#x27;Realtime&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/background-tasks">Background Tasks in PostGraphile</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/reserved-keywords">Reserved Keywords / Table Names</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/debugging">Debugging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><h4>CUSTOMISING</h4></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/postgraphile/current/smart-tags">Smart Tags</a><button aria-label="Toggle the collapsible sidebar category &#x27;Smart Tags&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/postgraphile/current/extending">Schema Plugins</a><button aria-label="Toggle the collapsible sidebar category &#x27;Schema Plugins&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/plugins">Server Plugins</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><h4>GUIDES</h4></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/postgraphile/current/postgresql-schema-design">PostgreSQL Schema Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/evaluating">Evaluating</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/best-practices">PostGraphile best practices</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/production">Production Considerations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/jwt-guide">PostGraphile JWT Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/jwk-verification">PostGraphile JWT/JWK Verification Quickstart</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/default-role">Default Role</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/pg-pubsub-migration">Migrating from the Supporter Plugin to @graphile/pg-pubsub</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/v4-new-features">v4 Feature Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/v3-migration">Migrating from PostGraphQL v3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/testing-jest">Testing with Jest</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/bundling-webpack">Bundling PostGraphile with Webpack</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/multiple-schemas">Multiple GraphQL Schemas with PostGraphile</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/running-postgraphile-in-docker">Running PostGraphile in Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/running-postgraphile-as-a-library-in-docker">Running PostGraphile as a library in Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><h4>DEPLOYING</h4></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/deploying-heroku">Deploying to Heroku</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/deploying-docker">Deploying with Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/deploying-lambda">Deploying to AWS Lambda</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/deploying-gcp">Deploying to GCP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><h4>COMMUNITY</h4></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/community-contributions">Community contributions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/community-chat">PostGraphile chat</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/code-of-conduct">Code of Conduct</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><h4>FAQ</h4></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/introspection">Introspection?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/why-nullable">Why is it nullable?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/postgraphile/current/versioning-policy">Versioning Policy</a></li></ul></nav></div></div></aside><main class="docMainContainer_fv3b"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_YAwJ"><div class="docItemContainer_Rv5Z"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_zCmv" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_JFrk"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">PostgreSQL Schema Design</span><meta itemprop="position" content="1"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 4.x</span><div class="tocCollapsible_O_Qc theme-doc-toc-mobile tocMobile_tjDr"><button type="button" class="clean-btn tocCollapsibleButton_htYj">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>PostgreSQL Schema Design</h1></header><p>The Postgres database is rich with features well beyond that of any other
database. However, most developers do not know the extent to which they can
leverage the features in Postgres to completely express their application
business logic in the database.</p><p>Often developers may find themselves re-implementing authentication and
authorization in their apps, when Postgres comes with application level security
features out of the box. Or perhaps developers may rewrite basic insert
functions with some extra app logic where that too may be handled in the
database.</p><p>This reimplementation of features that come with Postgres is not just an
inefficient way to spend developer resources, but may also result in an
interface that is slower than if the logic was implemented in Postgres itself.
PostGraphile aims to make developers more efficient and their APIs faster by
packaging the repeatable work in one open source project that encourages
community contributions.</p><p>In this tutorial we will walk through the Postgres schema design for a forum
application with users who can login and write forum posts. While we will
discuss how you can use the schema we create with PostGraphile, this article
should be useful for anyone designing a Postgres schema.</p><p>If you haven&#x27;t installed PostGraphile already, you can follow our
<a href="/postgraphile/current/quick-start-guide/">Quick Start Guide</a> to get PostGraphile up and running.</p><h3 class="anchor anchorWithStickyNavbar_fF9Z" id="table-of-contents">Table of Contents<a href="#table-of-contents" class="hash-link" aria-label="Direct link to Table of Contents" title="Direct link to Table of Contents">​</a></h3><ul><li><a href="#the-basics">The Basics</a><ul><li><a href="#setting-up-your-schemas">Setting Up Your Schemas</a></li><li><a href="#the-person-table">The Person Table</a></li><li><a href="#table-documentation">Table Documentation</a></li><li><a href="#the-post-table">The Post Table</a></li></ul></li><li><a href="#database-functions">Database Functions</a><ul><li><a href="#set-returning-functions">Set Returning Functions</a></li><li><a href="#triggers">Triggers</a></li></ul></li><li><a href="#authentication-and-authorization">Authentication and Authorization</a><ul><li><a href="#storing-emails-and-passwords">Storing Emails and Passwords</a></li><li><a href="#registering-users">Registering Users</a></li><li><a href="#postgres-roles">Postgres Roles</a></li><li><a href="#json-web-tokens">JSON Web Tokens</a></li><li><a href="#logging-in">Logging In</a></li><li><a href="#using-the-authorized-user">Using the Authorized User</a></li><li><a href="#grants">Grants</a></li><li><a href="#row-level-security">Row Level Security</a></li></ul></li><li><a href="#conclusion">Conclusion</a></li></ul><h3 class="anchor anchorWithStickyNavbar_fF9Z" id="the-basics">The Basics<a href="#the-basics" class="hash-link" aria-label="Direct link to The Basics" title="Direct link to The Basics">​</a></h3><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="setting-up-your-schemas">Setting Up Your Schemas<a href="#setting-up-your-schemas" class="hash-link" aria-label="Direct link to Setting Up Your Schemas" title="Direct link to Setting Up Your Schemas">​</a></h4><p>All of our database objects will go into one or two custom Postgres schemas. A
schema is essentially a namespace, it allows you to create tables with the same
name like <code>a.person</code> and <code>b.person</code>.</p><p>You can name your schema anything, we recommend naming your schema after your
app. This way if you are working on multiple apps in the same database (this
might only realistically happen in development), you can easily query the
databases of the different apps. We are going to create two schemas:
<code>forum_example</code>, and <code>forum_example_private</code>. To create these schemas we use the
<a href="https://www.postgresql.org/docs/current/static/sql-createschema.html" target="_blank" rel="noopener noreferrer"><code>CREATE SCHEMA</code></a>
command.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">schema</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">schema</span><span class="token plain"> forum_example_private</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You could create more or less schemas, it is all up to you and how you want to
structure your database. We decided to create two schemas. One of which,
<code>forum_example</code>, is meant to hold data users can see, whereas
<code>forum_example_private</code> will never be directly accessible to users.</p><p>Theoretically we want a user to be able to log in directly to our Postgres
database, and only be able to create, read, update, and delete data for their
user all within SQL. This is a mindshift from how we traditionally use a SQL
database. Normally, we assume whoever is querying the database has full
visibility into the system as the only one with database access is our
application. In this tutorial, we want to restrict access at the database level.
Don’t worry though! Postgres is very secure about this, users will have no more
permissions than that which you explicitly grant.</p><blockquote><p><strong>Note:</strong> When starting PostGraphile, you will want to use the name of the
schema you created with the <code>--schema</code> option, like so:
<code>postgraphile --schema forum_example</code>. Also, don’t forget to add the <code>--watch</code>
flag, with watch mode enabled PostGraphile will update your API as we add
tables and types throughout this tutorial.</p></blockquote><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="the-person-table">The Person Table<a href="#the-person-table" class="hash-link" aria-label="Direct link to The Person Table" title="Direct link to The Person Table">​</a></h4><p>Now we are going to create the tables in our database which will correspond to
our users. We will do this by running the Postgres
<a href="https://www.postgresql.org/docs/current/static/sql-createtable.html" target="_blank" rel="noopener noreferrer"><code>CREATE TABLE</code></a>
command. Here is the definition for our person table:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id               </span><span class="token keyword" style="color:#00009f">serial</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">primary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  first_name       </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">check</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">char_length</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">first_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_name        </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">check</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">char_length</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">last_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  about            </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  created_at       </span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we have created a table with <code>id</code>, <code>first_name</code>, <code>last_name</code>, <code>about</code>, and
<code>created_at</code> columns (we will add an <code>updated_at</code> column later). Let’s break
down exactly what each line in this command does, we will only do this once. If
you already understand, you can skip ahead.</p><ol><li><code>create table forum_example.person</code>: This tells Postgres that we are
creating a table in the <code>forum_example</code> schema named <code>person</code>. This table
will represent all of our forum’s users.</li><li><code>id serial primary key</code>: This line establishes an auto-incrementing id field
which is always guaranteed to be unique. The first person we create will
have an id of 1, the second user will have an id of 2, and so on. The
<code>primary key</code> bit is also very important. PostGraphile will use the
<code>primary key</code> of a table in many places to uniquely identify an object,
including the globally unique id field.</li><li><code>first_name text not null check (char_length(first_name) &lt; 80)</code>: We want all
of our users to enter their first name and last name separately, so this
column definition will create a column named <code>first_name</code>, of type <code>text</code>,
that is required (<code>not null</code>), and that must be less than 80 characters long
(<code>check (char_length(first_name) &lt; 80)</code>).
<a href="https://www.postgresql.org/docs/current/static/ddl-constraints.html" target="_blank" rel="noopener noreferrer">Check constraints</a>
are a very powerful feature in Postgres for data validation.</li><li><code>last_name text check (char_length(last_name) &lt; 80)</code>: This is very similar
to our column definition for <code>first_name</code>, except it is missing <code>not null</code>.
This means that unlike the <code>first_name</code> column, <code>last_name</code> is not required.</li><li><code>about text</code>: We want users to be able to express themselves! So they get to
write a mini forum post which will go on their profile page.</li><li><code>created_at timestamp default now()</code>: This final column definition will
provide us with some extra meta-information about their user. If not
specified explicitly, the <code>created_at</code> timestamp will default to the time
the row was inserted.</li></ol><p>And that’s our person table! Pretty simple, right?</p><p>The syntax and features of the Postgres
<a href="https://www.postgresql.org/docs/current/static/sql-createtable.html" target="_blank" rel="noopener noreferrer"><code>CREATE TABLE</code></a>
command are fairly easy to learn and understand. Creating tables is the easiest,
but also the most fundamental part of your schema design.</p><blockquote><p><strong>Note:</strong> We prefer singular identifers like <code>forum_example.person</code> over
<code>forum_example.people</code> because when you create a table, it is like you are
creating a class in an object-oriented language. Classes have singular names
like “Person” while collections will often have plural names like “People.”
Table as a class is a better analogy than table as a collection because
Postgres itself will internally call tables “classes.”</p></blockquote><blockquote><p><strong>Note:</strong> In case you don’t like serial id of our table above, an alternative
to the <code>serial</code> primary key is UUIDs. To use UUIDs you would just need to add
the popular UUID extension, <code>uuid-ossp</code>, in your database setup, and specify a
default in your table creation. Like so:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> extension </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">exists</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;uuid-ossp&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id uuid </span><span class="token keyword" style="color:#00009f">primary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">key</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> uuid_generate_v1mc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Alternatively you could use fully random UUIDs:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> extension </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">exists</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pgcrypto&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id uuid </span><span class="token keyword" style="color:#00009f">primary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">key</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> gen_random_uuid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There are pros and cons to both approaches, choose what works best for your
application!</p></blockquote><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="table-documentation">Table Documentation<a href="#table-documentation" class="hash-link" aria-label="Direct link to Table Documentation" title="Direct link to Table Documentation">​</a></h4><p>Now that we have created our table, we want to document it within the Postgres
database. By adding comments to our table and its columns using the Postgres
<a href="https://www.postgresql.org/docs/current/static/sql-comment.html" target="_blank" rel="noopener noreferrer"><code>COMMENT</code></a>
command, we will allow tools like PostGraphile to display rich domain specific
documentation.</p><p>To add comments, just see the SQL below:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;A user of the forum.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The primary unique identifier for the person.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">first_name </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The person’s first name.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_name </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The person’s last name.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">about </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;A short description about the user, written by the user.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">created_at </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The time this person was created.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Incredibly simple, yet also incredibly powerful.</p><blockquote><p><strong>Note:</strong> Feel free to write your comments in Markdown! Most tools, including
GraphiQL which PostGraphile uses, will render your comments with the
appropriate styles.</p></blockquote><p>With this we have completed our person table, now let’s create a table for our
forum posts.</p><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="the-post-table">The Post Table<a href="#the-post-table" class="hash-link" aria-label="Direct link to The Post Table" title="Direct link to The Post Table">​</a></h4><p>The users of our forum will want to be able to create posts. That’s the entire
reason we have a forum after all. To create the post table we go through a very
similar process as creating our <code>forum_example.person</code> table, but first we want
to create a type we will use in one of the columns. See the SQL below:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post_topic </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;discussion&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;inspiration&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;help&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;showcase&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The Postgres
<a href="https://www.postgresql.org/docs/current/static/sql-createtype.html" target="_blank" rel="noopener noreferrer"><code>CREATE TYPE</code></a>
command will let you create a custom type in your database which will allow you
to do some really cool things. You can create a
<a href="https://www.postgresql.org/docs/current/static/rowtypes.html" target="_blank" rel="noopener noreferrer">composite type</a>
which is basically a typed object in GraphQL terms, you can create a
<a href="https://www.postgresql.org/docs/current/static/rangetypes.html" target="_blank" rel="noopener noreferrer">range type</a>
which represents exactly what you might think, or you can create an
<a href="https://www.postgresql.org/docs/current/static/datatype-enum.html" target="_blank" rel="noopener noreferrer">enum type</a>
which is what we did here.</p><p>Enum types are a static set of values, you <em>must</em> use one of the string values
that make up the enum in any column of the enum’s type. Having this type is
useful for us, because we want our forum posts to have one, or none, topics so
user’s may easily see what a post is about.</p><blockquote><p><strong>Note:</strong> PostGraphile implements custom handling for user-defined types. An
enum type like that defined above will be turned into a GraphQL enum that
looks like:</p><div class="language-graphql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-graphql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token class-name">PostTopic</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">DISCUSSION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">INSPIRATION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">HELP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">SHOWCASE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can also create custom composite types which will turn into GraphQL object
types with PostGraphile.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> my_schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">my_type </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  foo </span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bar </span><span class="token keyword" style="color:#00009f">integer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Would become the following GraphQL type:</p><div class="language-graphql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-graphql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">MyType</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attr-name" style="color:#00a4db">foo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token scalar">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attr-name" style="color:#00a4db">bar</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token scalar">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>Now it is time to actually create our post table:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id               </span><span class="token keyword" style="color:#00009f">serial</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">primary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  author_id        </span><span class="token keyword" style="color:#00009f">integer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">references</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  headline         </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">check</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">char_length</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">headline</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">280</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  body             </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  topic            forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post_topic</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  created_at       </span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;A forum post written by a user.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The primary key for the post.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">headline </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The title written by the user.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">author_id </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The id of the author user.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">topic </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The topic this has been posted in.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The main body text of our post.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">created_at </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The time this post was created.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Pretty basic. Our <code>headline</code> is twice as long as a tweet, and to use our
<code>forum_example.post_topic</code> type we wrote it as the column type just as we may
write <code>integer</code> as the column type. We also made sure to include comments.</p><p>Now that we have gone over the basics, let’s explore Postgres functions and see
how we can use them to extend the functionality of our database.</p><h3 class="anchor anchorWithStickyNavbar_fF9Z" id="database-functions">Database Functions<a href="#database-functions" class="hash-link" aria-label="Direct link to Database Functions" title="Direct link to Database Functions">​</a></h3><p>The Postgres
<a href="https://www.postgresql.org/docs/current/static/sql-createfunction.html" target="_blank" rel="noopener noreferrer"><code>CREATE FUNCTION</code></a>
command is truly amazing. It allows us to write functions for our database in
SQL, and other languages including JavaScript and Ruby!</p><p>The following is a basic Postgres function:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">language</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sql</span><span class="token plain"> stable</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note the form. The double dollar signs (<code>$$</code>) open and close the function, and
at the very end we have <code>language sql stable</code>. <code>language sql</code> means that the
function is written in SQL, pretty obvious. If you wrote your function in Ruby
it may be <code>language plruby</code>. The next word, <code>stable</code>, means that this function
<em>does not</em> mutate the database. By default Postgres assumes all functions will
mutate the database, you must mark your function with <code>stable</code> for Postgres, and
PostGraphile, to know your function is a query and not a mutation.</p><blockquote><p><strong>Note:</strong> If you are interested in running JavaScript or Ruby in Postgres,
check out <a href="https://blog.heroku.com/javascript_in_your_postgres" target="_blank" rel="noopener noreferrer">PL/V8</a> and
<a href="https://github.com/knu/postgresql-plruby" target="_blank" rel="noopener noreferrer">PL/ruby</a> respectively. It is
recommended that you use SQL and PL/pgSQL (which comes native with Postgres)
whenever you can (even if they are a pain). There is plenty of documentation
and StackOverflow answers on both SQL and PL/pgSQL. However, there are
alternatives if you so choose.</p></blockquote><p>That function above isn’t so useful for us in our schema, so let’s write some
functions which will be useful. We will define three.</p><p>First, a function which will concatenate the users first and last name to return
their full name:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_full_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">person forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">first_name </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27; &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">language</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sql</span><span class="token plain"> stable</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_full_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;A person’s full name which is a concatenation of their first and last name.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Second, a function which will get a summary of a forum post:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post_summary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  post forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  length </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  omission </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;…&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">when</span><span class="token plain"> post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> substr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> omission</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">language</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sql</span><span class="token plain"> stable</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post_summary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;A truncated version of the body for summaries.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Third, a function that will get a person’s most recent forum post.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_latest_post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">person forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> post</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">author_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">order</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> created_at </span><span class="token keyword" style="color:#00009f">desc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">limit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">language</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sql</span><span class="token plain"> stable</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_latest_post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Get’s the latest post written by the person.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Don’t get too stuck on the function implementations. It is fairly easy to
discover how to express what you want in SQL through a quick search of the
Postgres documentation (which is excellent!). These functions are here to give
you some examples of what functions in Postgres look like. Also note how we
added comments to our functions with the
<a href="https://www.postgresql.org/docs/current/static/sql-comment.html" target="_blank" rel="noopener noreferrer"><code>COMMENT</code></a>
command, just like we add comments to our tables.</p><blockquote><p><strong>Note:</strong> Any function which meets the following conditions will be treated as
a computed field by PostGraphile:</p><ol><li>The function has a table row as the first argument.</li><li>The function is in the same schema as the table of the first argument.</li><li>The function’s name is prefixed by the table’s name.</li><li>The function is marked as <code>stable</code> or <code>immutable</code> which makes it a query
and not a mutation.</li></ol><p>All three of the above functions meet these conditions and as such will be
computed fields. In GraphQL this ends up looking like:</p><div class="language-graphql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-graphql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">Person</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attr-name" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token scalar">Int</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attr-name" style="color:#00a4db">firstName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token scalar">String</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attr-name" style="color:#00a4db">lastName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token scalar">String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attr-name" style="color:#00a4db">fullName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token scalar">String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attr-name" style="color:#00a4db">latestPost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Post</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="set-returning-functions">Set Returning Functions<a href="#set-returning-functions" class="hash-link" aria-label="Direct link to Set Returning Functions" title="Direct link to Set Returning Functions">​</a></h4><p>Sometimes it is useful to not just return single values from your function, but
perhaps entire tables. What returning a table from a function could mean is you
could define a custom ordering, hide rows that were archived, or return a user’s
activity feed perhaps. In our case, this Postgres feature makes it easy for us
to implement search:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">search_posts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">search </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> setof forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> post</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> position</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">search </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">headline</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">or</span><span class="token plain"> position</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">search </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">language</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sql</span><span class="token plain"> stable</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">search_posts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Returns posts containing a given search term.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The difference with this function and the ones before is the return signature
reads <code>returns setof forum_example.post</code>. This function will therefore return
all of the posts that match our search condition and not just one.</p><blockquote><p><strong>Note:</strong> PostGraphile will treat set returning functions as connections. This
is what makes them so powerful for PostGraphile users. The function above
would be queryable like so:</p><div class="language-graphql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-graphql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property-query">searchPosts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token attr-name" style="color:#00a4db">search</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Hello, world!&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token attr-name" style="color:#00a4db">first</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token object">edges</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">cursor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token object">node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">headline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><blockquote><p><strong>Note:</strong> Postgres has awesome text searching capabilities - if you want high
quality full text searching you don’t need to look outside Postgres. Instead
look into the Postgres
<a href="https://www.postgresql.org/docs/current/static/textsearch.html" target="_blank" rel="noopener noreferrer">Full Text Search</a>
functionality. It is a great feature, but a bit much for our simple example,
so we just used a simple string position function instead.</p></blockquote><blockquote><p><strong>Note:</strong> Returning an array (<code>returns post[]</code>), and returning a set
(<code>returns setof post</code>) are two very different things. When you return an
array, every single value in the array will always be returned. However, when
you return a set it is like returning a table. Users can paginate through a
set using <code>limit</code> and <code>offset</code>, but not an array.</p></blockquote><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="triggers">Triggers<a href="#triggers" class="hash-link" aria-label="Direct link to Triggers" title="Direct link to Triggers">​</a></h4><p>You can also use Postgres functions to define triggers. Triggers in Postgres
allow you to hook into events that are happening on your tables such as inserts,
updates, or deletes. You define your triggers with the
<a href="https://www.postgresql.org/docs/current/static/sql-createtrigger.html" target="_blank" rel="noopener noreferrer"><code>CREATE TRIGGER</code></a>
command, and all trigger functions must return the special type <code>trigger</code>.</p><p>To demonstrate how triggers work, we will define a trigger that sets an
<code>updated_at</code> column on our <code>forum_example.person</code> and <code>forum_example.post</code>
tables whenever a row is updated. Before we can write the trigger, we need to
make sure <code>forum_example.person</code> and <code>forum_example.post</code> have an <code>updated_at</code>
column! To do this we will use the
<a href="https://www.postgresql.org/docs/current/static/sql-altertable.html" target="_blank" rel="noopener noreferrer"><code>ALTER TABLE</code></a>
command.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">alter</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token keyword" style="color:#00009f">add</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> updated_at </span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">alter</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">add</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> updated_at </span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Our <code>updated_at</code> column has now been added to our tables and looks exactly like
our <code>created_at</code> column. It’s a timestamp which defaults to the time the row was
created. Next, let us define our triggers:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example_private</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_updated_at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trigger</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  new</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">current_timestamp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> new</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">language</span><span class="token plain"> plpgsql</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trigger</span><span class="token plain"> person_updated_at before </span><span class="token keyword" style="color:#00009f">update</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for each row</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">execute</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">procedure</span><span class="token plain"> forum_example_private</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_updated_at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trigger</span><span class="token plain"> post_updated_at before </span><span class="token keyword" style="color:#00009f">update</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for each row</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">execute</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">procedure</span><span class="token plain"> forum_example_private</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_updated_at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To define our trigger we ran three commands. First we created a function named
<code>set_updated_at</code> in our <code>forum_example_private</code> schema because we want no one to
directly call this function as it is simply a utility.
<code>forum_example_private.set_updated_at</code> also returns a <code>trigger</code> and is
implemented in
<a href="https://www.postgresql.org/docs/current/static/plpgsql.html" target="_blank" rel="noopener noreferrer">PL/pgSQL</a>.</p><p>After we define our <code>forum_example_private.set_updated_at</code> function, we can use
it in the triggers we create with the
<a href="https://www.postgresql.org/docs/current/static/sql-createtrigger.html" target="_blank" rel="noopener noreferrer"><code>CREATE TRIGGER</code></a>
command. The triggers will run before a row is updated by the
<a href="https://www.postgresql.org/docs/current/static/sql-update.html" target="_blank" rel="noopener noreferrer"><code>UPDATE</code></a>
command and will execute the function on every row being updated.</p><blockquote><p><strong>Note:</strong> If you find yourself wanting to do CPU intensive work in triggers,
instead consider using Postgres’ pub/sub functionality
(<a href="https://www.postgresql.org/docs/current/static/sql-listen.html" target="_blank" rel="noopener noreferrer"><code>LISTEN</code></a> /
<a href="https://www.postgresql.org/docs/current/static/sql-notify.html" target="_blank" rel="noopener noreferrer"><code>NOTIFY</code></a>) to
send the work to a &quot;worker service&quot; to be executed asynchronously.
<a href="https://github.com/graphile/worker" target="_blank" rel="noopener noreferrer">Graphile Worker</a> uses this pattern in a
fail-safe way; allowing you to run jobs &quot;in the background&quot; so that your HTTP
response/application code is not held up. We recommend using Graphile Worker
with any Node.js based PostgreSQL database that needs to queue actions such as
sending emails, push notifications, generating PDF reports and other such
asynchronous tasks.</p></blockquote><hr><p>That’s about it as far as Postgres functions go! They are a fun, interesting,
and useful topic to understand when it comes to good Postgres schema design.
Always remember, the Postgres documentation is your best friend as you try to
write your own functions. Some important documentation articles we mentioned for
your reference are as follows:</p><ul><li><a href="https://www.postgresql.org/docs/current/static/sql-createfunction.html" target="_blank" rel="noopener noreferrer"><code>CREATE FUNCTION</code></a></li><li><a href="https://www.postgresql.org/docs/current/static/sql-createtrigger.html" target="_blank" rel="noopener noreferrer"><code>CREATE TRIGGER</code></a></li><li><a href="https://www.postgresql.org/docs/current/static/plpgsql.html" target="_blank" rel="noopener noreferrer"><code>PL/pgSQL</code></a></li></ul><p>Next up, we are going to learn about auth in Postgres and PostGraphile!</p><h3 class="anchor anchorWithStickyNavbar_fF9Z" id="authentication-and-authorization">Authentication and Authorization<a href="#authentication-and-authorization" class="hash-link" aria-label="Direct link to Authentication and Authorization" title="Direct link to Authentication and Authorization">​</a></h3><p>Authentication and authorization is incredibly important whenever you build an
application. You want your users to be able to login and out of your service,
and only edit the content your platform has given them permission to edit.
Postgres already has great support for authentication and authorization using a
secure role based system, so PostGraphile just bridges the gap between the
Postgres role mechanisms and HTTP based authorization.</p><p>However, before we can dive into implementing authentication, we are missing
some pretty important data in our schema. How are users supposed to even login?
Not by guessing their first and last name one would hope, so we will define
another table which will store user emails and passwords.</p><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="storing-emails-and-passwords">Storing Emails and Passwords<a href="#storing-emails-and-passwords" class="hash-link" aria-label="Direct link to Storing Emails and Passwords" title="Direct link to Storing Emails and Passwords">​</a></h4><p>To store user emails and passwords we will create another table in the
<code>forum_example_private</code> schema.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example_private</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_account </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  person_id        </span><span class="token keyword" style="color:#00009f">integer</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">primary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">key</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">references</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">cascade</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email            </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unique</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">check</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">email </span><span class="token operator" style="color:#393A34">~</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;^.+@.+\..+$&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password_hash    </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example_private</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_account </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Private information about a person’s account.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example_private</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_id </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The id of the person associated with this account.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example_private</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">email </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;The email address of the person.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> forum_example_private</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">password_hash </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;An opaque hash of the person’s password.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p><strong>Warning:</strong> Never store passwords in plaintext! The <code>password_hash</code> column
will contain the user’s password <em>after</em> it has gone through a secure hashing
algorithm like <a href="https://codahale.com/how-to-safely-store-a-password/" target="_blank" rel="noopener noreferrer">Bcrypt</a>.
Later in this tutorial we will show you how to securely hash a password in
Postgres.</p></blockquote><p>Why would we choose to create a new table in the <code>forum_example_private</code> schema
instead of just adding columns to <code>forum_example.person</code>? There are a couple of
answers to this question. The first and most fundamental is separation of
concerns. By moving <code>email</code> and <code>password_hash</code> to a second table we make it
much harder to accidently select those values when reading
<code>forum_example.person</code>. Also, users will not have the permission to directly
query data from <code>forum_example_private</code> (as we will see) making this approach
more secure. This approach is also good for PostGraphile as the
<code>forum_example_private</code> schema is never exposed in PostGraphile, so you will
never accidently expose password hashes in GraphQL.</p><p>Besides those arguments, moving the person’s account to a separate table is also
good database design in general. Say you have multiple types of users. Perhaps
normal person users, and then ’brand‘ or ‘organization’ users. This pattern
could easily allow you to go in that direction.</p><blockquote><p><strong>Note:</strong> The <code>forum_example_private.person_account</code> shares its primary key
with <code>forum_example.person</code>. This way there can only be one
<code>forum_example_private.person_account</code> for every <code>forum_example.person</code>, a
one-to-one relationship.</p></blockquote><blockquote><p><strong>Note:</strong> For an example of a much richer user profile/account/login schema,
use
<a href="https://github.com/membership/membership.db/tree/master/postgres" target="_blank" rel="noopener noreferrer">Membership.db</a>
as a reference.</p></blockquote><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="registering-users">Registering Users<a href="#registering-users" class="hash-link" aria-label="Direct link to Registering Users" title="Direct link to Registering Users">​</a></h4><p>Before a user can log in, they need to have an account in our database. To
register a user we are going to implement a Postgres function in PL/pgSQL which
will create two rows. The first row will be the user’s profile inserted into
<code>forum_example.person</code>, and the second will be an account inserted into
<code>forum_example_private.person_account</code>.</p><p>Before we define the function, we know that we will want to hash the passwords
coming into the function before inserting them into
<code>forum_example_private.person_account</code>. To hash passwords we will need the
Postgres
<a href="https://www.postgresql.org/docs/current/static/pgcrypto.html" target="_blank" rel="noopener noreferrer"><code>pgcrypto</code></a>
extension. To add the extension, just do the following:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> extension </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">exists</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pgcrypto&quot;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>pgcrypto</code> extension should come with your Postgres distribution and gives
us access to hashing functions like <code>crypt</code> and <code>gen_salt</code> which were
specifically designed for hashing passwords.</p><p>Now that we have added <code>pgcrypto</code> to our database, let us define our function:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">register_person</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  first_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">declare</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  person forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">insert</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">first_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">first_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">returning</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">insert</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> forum_example_private</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_account </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">person_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> email</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> password_hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> email</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> crypt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">password</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gen_salt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;bf&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">language</span><span class="token plain"> plpgsql strict security </span><span class="token keyword" style="color:#00009f">definer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">register_person</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Registers a single user and creates an account in our forum.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you do not understand what is going on here, do not worry, writing PL/pgSQL
requires some trial and error along with some StackOverflow searching. What’s
new here compared to our other functions is that we have a new block, <code>declare</code>,
above our function implementation which starts with <code>begin</code>. In that block we
declare our intention to use a variable called <code>person</code> of type
<code>forum_example.person</code>. Then, in our first insert statement, the row we insert
will be saved into that <code>person</code> variable.</p><p>After we insert a profile into <code>forum_example.person</code>, we use the <code>pgcrypto</code>
extension in the expression <code>crypt(password, gen_salt(&#x27;bf&#x27;))</code> to hash the user’s
password before inserting into <code>forum_example_private.person_account</code>. This way
we aren’t storing the password in plaintext. Read the documentation for
<code>pgcrypto</code> on
<a href="https://www.postgresql.org/docs/current/static/pgcrypto.html#AEN178870" target="_blank" rel="noopener noreferrer">Password Hashing Functions</a>
to learn more about these functions and their characteristics.</p><blockquote><p><strong>Warning:</strong> Be very careful with logging, while we encrypt our passwords here
it may be possible that in a query or server log the password will be recorded
in plain text! Be careful to configure your Postgres logs so this isn’t the
case. PostGraphile will never log the value of any variables the client gives
it. Being careful with your logs and passwords is true in any system, but
especially this one.</p><p>For an overview of passwords in Postgres past the <code>pgcrypto</code> documentation,
see the answer to the StackOverflow question
“<a href="http://stackoverflow.com/a/18687445/1568890" target="_blank" rel="noopener noreferrer">How can I hash passwords in Postgres?</a>”</p></blockquote><p>At the end of the implementation you will see
<code>language plpgsql strict security definer</code>. <code>language plpgsql</code> we already
understand, but the other words are new. The word <code>strict</code> means that if the
function gets null input, then the output will be automatically null as well and
Postgres won’t call the function. That is <code>password</code> cannot be null or
<code>first_name</code> cannot be null otherwise the result will also be null and nothing
will be executed. The words <code>security definer</code> mean that this function is
executed with the privileges of the Postgres user who created it. Remember how
we said users would never be able to insert into
<code>forum_example_private.person_account</code>? Well this function can insert into
<code>forum_example_private.person_account</code> because it uses the privileges of the
definer.</p><blockquote><p><strong>Warning:</strong> Make sure that when you create a function with <code>security definer</code>
there are no ‘holes’ a user could use to see or mutate more data than they are
not allowed to. Since the above is a simple function, we are fine. If you
don’t need <code>security definer</code>, try not to use it.</p></blockquote><p>This function will create a user and their account, but how will we log the user
in? Before we define a function which allows users to login, sign-in,
authenticate, whatever you want to call it let us go over how auth works at a
high level in PostGraphile. While this article is trying to be somewhat
PostGraphile agnostic, the next two sections will be specific to PostGraphile,
but useful to anyone wanting to learn just a little bit more about Postgres and
JSON Web Tokens (JWTs).</p><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="postgres-roles">Postgres Roles<a href="#postgres-roles" class="hash-link" aria-label="Direct link to Postgres Roles" title="Direct link to Postgres Roles">​</a></h4><p>When a user logs in, we want them to make their queries using a specific
PostGraphile role. Using that role we can define rules that restrict what data
the user may access. So what roles do we need to define for our forum example?
Remember when we were connecting to Postgres and we used a URL like
<code>postgres:///mydb</code>? Well, when you use a connection string like that, you are
logging into Postgres using your computer account’s username and no password.
Say your computer account username is <code>buddy</code>, then connecting with the URL
<code>postgres:///mydb</code>, would be the same as connecting with the URL
<code>postgres://buddy@localhost/mydb</code> or even specifying the port explicitly:
<code>postgres://buddy@localhost:5432/mydb</code>. If you wanted to connect to your
Postgres database with a password it would look like
<code>postgres://buddy:password@localhost/mydb</code>. When you run Postgres locally, this
account will probably be the superuser. So when you run
<code>postgraphile -c postgres:///mydb</code>, you are running PostGraphile with superuser
privileges. To change that let’s create a role that PostGraphile can use to
connect to our database:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> role forum_example_postgraphile login password </span><span class="token string" style="color:#e3116c">&#x27;xyz&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We create this <code>forum_example_postgraphile</code> role with the
<a href="https://www.postgresql.org/docs/current/static/sql-createrole.html" target="_blank" rel="noopener noreferrer"><code>CREATE ROLE</code></a>
command. We want to make sure our PostGraphile role can login so we specify that
with the <code>login</code> option and we give the user a password of ‘xyz’ with the
<code>password</code> option. Now we will start PostGraphile as such:</p><div class="language-bash codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-bash codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token plain">postgraphile -c postgres://forum_example_postgraphile:xyz@localhost/mydb</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When a user who does not have a JWT token makes a request to Postgres, we do not
want that user to have the privileges we will give to the
<code>forum_example_postgraphile</code> role, so instead we will create another role.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> role forum_example_anonymous</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> forum_example_anonymous </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_postgraphile</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here we use
<a href="https://www.postgresql.org/docs/current/static/sql-createrole.html" target="_blank" rel="noopener noreferrer"><code>CREATE ROLE</code></a>
again. This role cannot login so it does not have the <code>login</code> option, or a
password. We also use the
<a href="https://www.postgresql.org/docs/current/static/sql-grant.html" target="_blank" rel="noopener noreferrer"><code>GRANT</code></a> command
to grant access to the <code>forum_example_anonymous</code> role to the
<code>forum_example_postgraphile</code> role. Now, the <code>forum_example_postgraphile</code> role
can control and become the <code>forum_example_anonymous</code> role. If we did not use
that grant, we could not change into the <code>forum_example_anonymous</code> role in
PostGraphile. Now we will start our server like so:</p><div class="language-bash codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-bash codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token plain">postgraphile </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --connection postgres://forum_example_postgraphile:xyz@localhost/mydb </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --default-role forum_example_anonymous</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There is one more role we want to create. When a user logs in we don’t want them
to use the <code>forum_example_postgraphile</code> role, or the basic
<code>forum_example_anonymous</code> role. So instead we will create a role that all of our
logged in users will authorize with. We will call it <code>forum_example_person</code> and
similarly grant it to the <code>forum_example_postgraphile</code> role.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> role forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> forum_example_person </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_postgraphile</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p><strong>Warning:</strong> The <code>forum_example_postgraphile</code> role will have all of the
permissions of the roles granted to it. So it can do everything
<code>forum_example_anonymous</code> can do and everything <code>forum_example_person</code> can do.
This is why having a default role is important. We would not want an anonymous
user to have admin access level because we have granted an admin role to
<code>forum_example_postgraphile</code>.</p></blockquote><p>Ok, so now we have three roles. <code>forum_example_postgraphile</code>,
<code>forum_example_anonymous</code>, and <code>forum_example_person</code>. We know how
<code>forum_example_postgraphile</code> and <code>forum_example_anonymous</code> get used, but how do
we know when a user is logged in and should be using <code>forum_example_person</code>? The
answer is JSON Web Tokens.</p><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="json-web-tokens">JSON Web Tokens<a href="#json-web-tokens" class="hash-link" aria-label="Direct link to JSON Web Tokens" title="Direct link to JSON Web Tokens">​</a></h4><p>PostGraphile uses <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JSON Web Tokens (JWTs)</a> for authorization. A
JWT is just a JSON object that has been hashed and cryptographically signed to
confirm the identity of its contents. So an object like:</p><div class="language-json codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-json codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;a&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;b&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;c&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Would turn into a token that looks like:</p><div class="codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token plain">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhIjoxLCJiIjoyLCJjIjozfQ.hxhGCCCmGV9nT1slief1WgEsOsfdnlVizNrODxfh1M8</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p><strong>Warning:</strong> The information in a JWT can be read by anyone, so do not put
private information in a JWT. What makes JWTs secure is that unless they were
signed by our secret, we can not accept the information inside the JWT as
truth.</p></blockquote><p>This allows PostGraphile to securely make claims about who a user is. Attackers
would not be able to fake a claim unless they had access to the private ‘secret’
you define when you start PostGraphile with the <code>--jwt-secret</code> option.</p><p>When PostGraphile gets a JWT from an HTTP request’s <code>Authorization</code> header, like
so:</p><div class="codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token plain">Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhIjoxLCJiIjoyLCJjIjozfQ.hxhGCCCmGV9nT1slief1WgEsOsfdnlVizNrODxfh1M8</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It will verify the token using the secret, and then will serialize the claims in
that token to the database. So for our token above PostGraphile would
effectively run:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">local</span><span class="token plain"> jwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">claims</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">local</span><span class="token plain"> jwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">claims</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">local</span><span class="token plain"> jwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">claims</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This way your JWT is accessible in your database rules. To get these values back
out in SQL, just run the following function:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> current_setting</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;jwt.claims.a&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>All of the ‘claims’ or properties on the JWT are serialized to the database in
this way, with one exception. If you have a <code>role</code> property in your JWT,
PostGraphile will also set the Postgres role of the local transaction. So say
you had a <code>role</code> of <code>forum_example_person</code>. PostGraphile would run:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">local</span><span class="token plain"> role </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;forum_example_person&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">local</span><span class="token plain"> jwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">claims</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">role </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;forum_example_person&#x27;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, the user would have the permissions of the <code>forum_example_person</code> role as
they execute their query.</p><blockquote><p><strong>Warning:</strong> Unless explicitly set, JWTs never expire. Once they have been
issued they may never be invalidated. This is both good and bad, good in that
JWTs are fast in not requiring a database lookup. Bad in that if an attacker
gets their hands on a JWT you can’t stop them from using it until the token
expires. If you do not override <code>exp</code> then <strong>PostGraphile&#x27;s defaults set JWTs
to expire after one day</strong>.</p><p>A solution to this is to use very short expiration times on your tokens and/or
to use refresh tokens. A refresh token you would use whenever your JWT expires
to get a new JWT without prompting the user for their password again. Refresh
tokens would be stored in the database so you could easily invalidate refresh
tokens.</p></blockquote><p>We now know how PostGraphile uses JWTs to authorize the user, but how does
PostGraphile create a JWT? Stay tuned.</p><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="logging-in">Logging In<a href="#logging-in" class="hash-link" aria-label="Direct link to Logging In" title="Direct link to Logging In">​</a></h4><p>You can pass an option to PostGraphile, called
<code>--jwt-token-identifier &lt;identifier&gt;</code> in the CLI, which takes a composite type
identifier. PostGraphile will turn this type into a JWT wherever you see it in
the GraphQL output. So let’s define the type we will use for our JWTs:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jwt_token </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  person_id </span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exp </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That’s it. We are using the
<a href="https://www.postgresql.org/docs/current/static/sql-createtype.html" target="_blank" rel="noopener noreferrer"><code>CREATE TYPE</code></a>
command again as we did before to create an enum type. This time we are creating
a composite type. The definition for a composite type looks very much like the
definition of a table type, except a composite type cannot store rows. i.e. you
can’t <code>INSERT</code>, <code>SELECT</code>, <code>UPDATE</code>, or <code>DELETE</code> from a composite type. While you
can’t store rows in a composite type, PostGraphile can turn a composite type
into a JWT. Now that we’ve defined this type we will want to start PostGraphile
with the <code>--jwt-token-identifier</code> flag:</p><div class="language-bash codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-bash codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token plain">postgraphile --jwt-token-identifier forum_example.jwt_token</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next we need to create the function which will actually return the token:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">authenticate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jwt_token </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">declare</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account forum_example_private</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_account</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> forum_example_private</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_account </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">email </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">password_hash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> crypt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">password</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">password_hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;forum_example_person&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">epoch </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2 days&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jwt_token</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">language</span><span class="token plain"> plpgsql strict security </span><span class="token keyword" style="color:#00009f">definer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">authenticate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Creates a JWT token that will securely identify a person and give them certain permissions. This token expires in 2 days.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This function will return null if the user failed to authenticate, and a JWT
token if the user succeeds. Returning null could mean that the password was
incorrect, a user with their email doesn’t exist, or the client forgot to pass
<code>email</code> and/or <code>password</code> arguments. It is then up to the client to raise an
error when encountering <code>null</code>. If a user with the provided email <em>does</em> exist,
and the provided password checks out with <code>password_hash</code> in
<code>forum_example_private.person_account</code> then we return an instance of
<code>forum_example.jwt_token</code> which will then be converted into an actual JWT by
PostGraphile.</p><p>There are two main parts to our function body. The first is:</p><div class="language-plpgsql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-plpgsql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token plain">select a.* into account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from forum_example_private.person_account as a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">where a.email = $1;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This code will select a single account from
<code>forum_example_private.person_account</code> using the provided email value. The <code>$1</code>
here is just another way to write the <code>email</code> argument. If we had wrote
<code>email = email</code> or even <code>a.email = email</code>, Postgres would not have known which
email we were referring to, so instead we just used a substitute for the <code>email</code>
argument which depends on its placement in the identifer <code>$1</code>. If we
successfully find a person with that email, we store it in the <code>account</code>
variable. If we do not find anything, <code>account</code> will be null. The second part of
our function is:</p><div class="language-plpgsql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-plpgsql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token plain">if account.password_hash = crypt(password, account.password_hash) then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return (&#x27;forum_example_person&#x27;, account.person_id)::forum_example.jwt_token;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end if;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is an if/else statement that checks to see if the plaintext <code>password</code>
argument we were provided matches the password hash that was stored in our
<code>forum_example_private.person_account</code>’s <code>password_hash</code> table. If there is a
match, then we return a JWT token. Otherwise we return null. The password match
check is done in the code
<code>account.password_hash = crypt(password, account.password_hash)</code>. To better
understand how this works, read the documentation for <code>pgcrypto</code> on
<a href="https://www.postgresql.org/docs/current/static/pgcrypto.html#AEN178870" target="_blank" rel="noopener noreferrer">password hashing functions</a>.</p><p>In order to construct a <code>forum_example.jwt_token</code> we use the Postgres
<a href="https://www.postgresql.org/docs/11/rowtypes.html#id-1.5.7.24.6" target="_blank" rel="noopener noreferrer">composite value input</a>
syntax which looks like:
<code>(&#x27;forum_example_person&#x27;, account.person_id, extract(epoch from (now() + interval &#x27;2 days&#x27;)))</code>.
Then we cast that composite value with <code>::forum_example.jwt_token</code>. We use
Postgres
<a href="https://www.postgresql.org/docs/current/functions-datetime.html" target="_blank" rel="noopener noreferrer">date/time functions</a>
to generate a date that is two days from the current date, and then convert it
to a POSIX timestamp. The order in which the values go is the order in which
they were originally defined. Since we defined <code>role</code>, <code>person_id</code> and <code>exp</code>,
this JWT will have a <code>role</code> of <code>forum_example_person</code>, a <code>person_id</code> of
<code>account.person_id</code>, and an <code>exp</code> that is two days from now.</p><blockquote><p><strong>Warning:</strong> Be careful about logging around this function too.</p></blockquote><p>Now that we know how to get JWTs for our users, let’s use the JWTs.</p><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="using-the-authorized-user">Using the Authorized User<a href="#using-the-authorized-user" class="hash-link" aria-label="Direct link to Using the Authorized User" title="Direct link to Using the Authorized User">​</a></h4><p>Before we define permissions for our user, let’s utilize the fact that they are
logged in by defining a quick Postgres function.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current_person</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullif</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_setting</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;jwt.claims.person_id&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">integer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">language</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sql</span><span class="token plain"> stable</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current_person</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">is</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Gets the person who was identified by our JWT.&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is a simple function that we can use in PostGraphile or our database to get
the person who is currently executing the query — by means of the token in the
request header. The one new concept here is
<code>nullif(current_setting(&#x27;jwt.claims.person_id&#x27;, true), &#x27;&#x27;)::integer</code>. As we
discussed before, PostGraphile will serialize your JWT to the database in the
form of transaction local settings. Using the <code>current_setting</code> function is how
we access those settings. Also note that we cast the value to an integer with
<code>::integer</code>. This is because the Postgres <code>current_setting</code> function will always
return a string, if you need another data type, you will likely need to cast to
that data type.</p><p>Now, let’s use the JWT to define permissions.</p><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="grants">Grants<a href="#grants" class="hash-link" aria-label="Direct link to Grants" title="Direct link to Grants">​</a></h4><p>The highest level of permission that can be given to roles using the Postgres
are access privileges assigned using the
<a href="https://www.postgresql.org/docs/current/static/sql-grant.html" target="_blank" rel="noopener noreferrer"><code>GRANT</code></a>
command. The access privileges defined by <code>GRANT</code> work on no smaller level than
the table level. As you can allow a role to select any value from a table, or
delete any value in a table. We will look at how to restrict access on a row
level next.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- after schema creation and before function creation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">alter</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">privileges</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">revoke</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">execute</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> functions </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usage</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">schema</span><span class="token plain"> forum_example </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_anonymous</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_anonymous</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">update</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_anonymous</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">insert</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">update</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usage</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> sequence forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post_id_seq </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">execute</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_full_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_anonymous</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">execute</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post_summary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_anonymous</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">execute</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person_latest_post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_anonymous</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">execute</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">search_posts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_anonymous</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">execute</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">authenticate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_anonymous</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">execute</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current_person</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_anonymous</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> forum_example_person</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">grant</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">execute</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">register_person</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_anonymous</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>See how we had to grant permissions on every single Postgres object we have
defined so far? Postgres permissions work as a whitelist and not a blacklist
(except for functions), so therefore no one has more access than you explicitly
give them. Let’s walk through the grants:</p><ol><li><code>alter default privileges ...</code>: By default, functions can be executable by
public. Since we&#x27;re applying our fine-grained control over function
permissions here, we remove the default grant. Note that this line needs to
be placed before any function definition.</li><li><code>grant usage on schema forum_example to forum_example_anonymous, forum_example_person</code>:
We say that anonymous users (<code>forum_example_anonymous</code>) and logged in users
(<code>forum_example_person</code>) may use the objects in the <code>forum_example</code> schema.
This does not mean that those roles can use anything they want in the
schema, it just allows the roles to know the schema exists. Also note that
we did not grant usage for the <code>forum_example_private</code> schema.</li><li><code>grant select on table forum_example.person to forum_example_anonymous, forum_example_person</code>:
We give anonymous users and logged in users the ability to read all of the
rows in the <code>forum_example.person</code> table.</li><li><code>grant update, delete on table forum_example.person to forum_example_person</code>:
Here we give <em>only</em> logged in users the ability to update and delete rows
from the <code>forum_example.person</code> table. This means that anonymous users can
never update or delete a person. However, it does mean that users can update
and delete any rows in the table. We will fix this later.</li><li><code>grant select ...</code> and <code>grant insert, update, delete ...</code>: We do the same
thing with these two grants as we did with the grants above. The only
difference here is that we also give signed in users the ability to <code>insert</code>
into <code>forum_example.post</code>. We do not allow anyone to insert directly into
<code>forum_example.person</code>, instead users should use the
<code>forum_example.register_person</code> function.</li><li><code>grant usage on sequence forum_example.post_id_seq to forum_example_person</code>:
When a user creates a new <code>forum_example.post</code> they will also need to get
the next value in the <code>forum_example.post_id_seq</code> because we use the
<code>serial</code> data type for the <code>id</code> column. A sequence also exists for our
person table (<code>forum_example.person_id_seq</code>), but since we are only creating
people through <code>forum_example.register_person</code> and that function specifies
<code>security definer</code>, we don’t need to grant access to the person id sequence.</li><li><code>grant execute ...</code>: We have to give the anonymous user and logged in users
access to all of the Postgres functions we define. All of the functions are
executable by both types of users, except <code>forum_example.register_person</code>
which we only let anonymous users execute. There’s no need for logged in
users to register a new user!</li></ol><p>This provides basic permissions for all of our Postgres objects, but as we
mentioned before users can update and delete all and any persons or posts. For
obvious reasons we don’t want this, so let’s define row level security next.</p><h4 class="anchor anchorWithStickyNavbar_fF9Z" id="row-level-security">Row Level Security<a href="#row-level-security" class="hash-link" aria-label="Direct link to Row Level Security" title="Direct link to Row Level Security">​</a></h4><p>In Postgres 9.5 (released January 2016)
<a href="https://www.postgresql.org/docs/current/static/ddl-rowsecurity.html" target="_blank" rel="noopener noreferrer">Row Level Security (RLS)</a>
was introduced. RLS allows us to specify access to the data in our Postgres
databases on a row level instead of a table level. In order to enable row level
security on our tables we first need to run the following:</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">alter</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token keyword" style="color:#00009f">enable</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">row</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">level</span><span class="token plain"> security</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">alter</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">enable</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">row</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">level</span><span class="token plain"> security</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Before running these commands, the <code>forum_example_person</code> and
<code>forum_example_anonymous</code> roles could see every row in the table with a
<code>select * from forum_example.person</code> query. After running these two commands
those same roles can’t. By enabling row level security, our roles don’t have any
access to read or write to a table that you don’t explicitly give, so to
re-enable access to all the rows we will define RLS policies with the
<a href="https://www.postgresql.org/docs/current/static/sql-createpolicy.html" target="_blank" rel="noopener noreferrer"><code>CREATE POLICY</code></a>
command.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> policy select_person </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> policy select_post </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now both anonymous users and logged in users can see all of our
<code>forum_example.person</code> and <code>forum_example.post</code> rows again. We also want signed
in users to be able to only update and delete their own row in
<code>forum_example.person</code>.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> policy update_person </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_person</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullif</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_setting</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;jwt.claims.person_id&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> policy delete_person </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">person </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_person</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullif</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_setting</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;jwt.claims.person_id&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We use the current <code>person_id</code> from our JWT and only allow updates and deletes
on rows with the same id. Also note how we added to <code>forum_example_person</code>. This
is because we only want these policies to apply for the <code>forum_example_person</code>
role.</p><p>That’s all we need to define for our person table. Now let’s define three
policies for our posts table. One for <code>INSERT</code>, <code>UPDATE</code>, and <code>DELETE</code>.</p><div class="language-sql codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-sql codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> policy insert_post </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">insert</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_person</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">check</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">author_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullif</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_setting</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;jwt.claims.person_id&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> policy update_post </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_person</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">author_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullif</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_setting</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;jwt.claims.person_id&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> policy delete_post </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> forum_example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">to</span><span class="token plain"> forum_example_person</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">author_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullif</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_setting</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;jwt.claims.person_id&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>These policies are very similar to the ones before, except that the
<code>insert_post</code> policy uses <code>with check</code> instead of <code>using</code> like our other
policies. The difference between <code>with check</code> and <code>using</code> is roughly that
<code>using</code> is applied <em>before</em> any operation occurs to the table’s rows. So in the
case of updating a post, one could not update a row that does not have the
appropriate <code>author_id</code> in the first place. <code>with check</code> is run <em>after</em> an
operation is applied. If the <code>with check</code> fails the operation will be rejected.
So in the case of an insert, Postgres sets all of the columns as specified and
then compares against <code>with check</code> on the new row. You must use <code>with check</code>
with <code>INSERT</code> commands because there are no rows to compare against before
insertion, and you must use <code>using</code> with <code>DELETE</code> commands because a delete
changes no rows only removes current ones.</p><p>That’s it! We have successfully created a Postgres schema embedded with our
business logic. When we use this schema with PostGraphile we will get a well
designed GraphQL API that we can use in our frontend application.</p><p>The final argument list for starting our PostGraphile server using the CLI would
be as follows:</p><div class="language-bash codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_qZBB"><pre tabindex="0" class="prism-code language-bash codeBlock_TAPP thin-scrollbar"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#393A34"><span class="token plain">postgraphile </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --connection postgres://forum_example_postgraphile:xyz@localhost </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --schema forum_example </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --default-role forum_example_anonymous </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --jwt-secret keyboard_kitten </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --jwt-token-identifier forum_example.jwt_token</span><br></span></code></pre><div class="buttonGroup_TNwR"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MVhB" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_yxgH"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_QJLJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h3 class="anchor anchorWithStickyNavbar_fF9Z" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h3><p>You should now be equipped with the knowledge to go out and design your own
Postgres schema. If you have any questions, encounter a bug, or just want to say
thank you, don’t hesitate to
<a href="https://github.com/graphile/postgraphile/issues" target="_blank" rel="noopener noreferrer">open an issue</a>, we’d love to
hear from you. The PostGraphile community wants to invest in making you a
productive developer so that you can invest back into PostGraphile.</p><p><em>This article was originally written by
<a href="https://twitter.com/calebmer" target="_blank" rel="noopener noreferrer">Caleb Meredith</a>.</em></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/graphile/crystal/tree/main/postgraphile/website/versioned_docs/version-4.x/postgresql-schema-design.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_UohW" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_T23F"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/postgraphile/current/plugins"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Server Plugins</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/postgraphile/current/evaluating"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Evaluating</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_TN1Q thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#table-of-contents" class="table-of-contents__link toc-highlight">Table of Contents</a></li><li><a href="#the-basics" class="table-of-contents__link toc-highlight">The Basics</a></li><li><a href="#database-functions" class="table-of-contents__link toc-highlight">Database Functions</a></li><li><a href="#authentication-and-authorization" class="table-of-contents__link toc-highlight">Authentication and Authorization</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://postgraphile.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">PostGraphile</a></li><li class="footer__item"><a class="footer__link-item" href="/grafast">Gra<em>fast</em></a></li><li class="footer__item"><a href="https://build.graphile.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Graphile Build</a></li><li class="footer__item"><a href="https://star.graphile.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Graphile*</a></li><li class="footer__item"><a href="https://grafast.org/ruru/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Ruru</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/graphile" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_awgD"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/GraphileHQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_awgD"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://fosstodon.org/@graphile" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mastodon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_awgD"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/graphile/crystal" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_awgD"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://graphile.org/sponsor/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsor<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_awgD"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/logo.svg" alt="PostGraphile Logo" class="themedImage_RWGG themedImage--light_riBm footer__logo" width="64" height="64"><img src="/img/logo.svg" alt="PostGraphile Logo" class="themedImage_RWGG themedImage--dark_Dsi0 footer__logo" width="64" height="64"></div><div class="footer__copyright">Copyright © 2024 Graphile Ltd. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.80bf8250.js"></script>
<script src="/assets/js/main.4f3a8e0c.js"></script>
</body>
</html>