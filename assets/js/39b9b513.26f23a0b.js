"use strict";(self.webpackChunk_localrepo_star_website=self.webpackChunk_localrepo_star_website||[]).push([[2631],{876:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>f});var r=n(2784);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=r.createContext({}),c=function(e){var t=r.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=c(e.components);return r.createElement(i.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),m=a,f=p["".concat(i,".").concat(m)]||p[m]||d[m]||o;return n?r.createElement(f,l(l({ref:t},u),{},{components:n})):r.createElement(f,l({ref:t},u))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=m;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s[p]="string"==typeof e?e:a,l[1]=s;for(var c=2;c<o;c++)l[c]=n[c];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},9136:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var r=n(7896),a=(n(2784),n(876));const o={sidebar_position:1},l="pg-sql2 Introduction",s={unversionedId:"index",id:"index",title:"pg-sql2 Introduction",description:"Create highly dynamic SQL in a powerful and flexible manner without opening yourself to SQL injection attacks.",source:"@site/pg-sql2/index.md",sourceDirName:".",slug:"/",permalink:"/pg-sql2/",draft:!1,editUrl:"https://github.com/graphile/crystal/tree/main/utils/website/pg-sql2/index.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",next:{title:"API",permalink:"/pg-sql2/api/"}},i={},c=[{value:"Usage",id:"usage",level:2},{value:"History",id:"history",level:2}],u={toc:c},p="wrapper";function d(e){let{components:t,...n}=e;return(0,a.kt)(p,(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"pg-sql2-introduction"},"pg-sql2 Introduction"),(0,a.kt)("p",null,"Create highly dynamic SQL in a powerful and flexible manner without opening yourself to SQL injection attacks."),(0,a.kt)("p",null,"A key aim of this library is to be very fast, if you think you can improve performance further please open a PR!"),(0,a.kt)("h2",{id:"usage"},"Usage"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'const { default: sql } = require("pg-sql2");\n// or import sql from \'pg-sql2\';\n\nconst tableName = "user";\nconst fields = ["name", "age", "height"];\n\n// sql.join is used to join fragments with a common separator, NOT to join tables!\nconst sqlFields = sql.join(\n  // sql.identifier safely escapes arguments and joins them with dots\n  fields.map((fieldName) => sql.identifier(tableName, fieldName)),\n  ", ",\n);\n\n// sql.value will store the value and instead add a placeholder to the SQL\n// statement, to ensure that no SQL injection can occur.\nconst sqlConditions = sql`created_at > NOW() - interval \'3 years\' and age > ${sql.value(\n  22,\n)}`;\n\n// This could be a full query, but we\'re going to embed it in another query safely\nconst innerQuery = sql`select ${sqlFields} from ${sql.identifier(\n  tableName,\n)} where ${sqlConditions}`;\n\n// Symbols are automatically assigned unique identifiers\nconst sqlAlias = sql.identifier(Symbol());\n\nconst query = sql`\nwith ${sqlAlias} as (${innerQuery})\nselect\n  (select json_agg(row_to_json(${sqlAlias})) from ${sqlAlias}) as all_data,\n  (select max(age) from ${sqlAlias}) as max_age\n`;\n\n// sql.compile compiles the query into an SQL statement and a list of values\nconst { text, values } = sql.compile(query);\n\nconsole.log(text);\n/* ->\nwith __local_0__ as (select "user"."name", "user"."age", "user"."height" from "user" where created_at > NOW() - interval \'3 years\' and age > $1)\nselect\n  (select json_agg(row_to_json(__local_0__)) from __local_0__) as all_data,\n  (select max(age) from __local_0__) as max_age\n*/\n\nconsole.log(values); // [ 22 ]\n\n// Then to run the query using `pg` module, do something like:\n// const { rows } = await pg.query(text, values);\n')),(0,a.kt)("h2",{id:"history"},"History"),(0,a.kt)("p",null,"This is a replacement for ",(0,a.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/pg-sql"},"@calebmer's pg-sql"),", combining the additional work that was done to it ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/postgraphql/postgraphql/blob/9c36d7e9b9ad74e665de18964fd2554f9f639903/src/postgres/utils/sql.ts"},"in postgraphql")," and offering the following enhancements:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Better development experience for people not using TypeScript (throws errors a lot earlier allowing you to catch issues at the source)"),(0,a.kt)("li",{parentName:"ul"},"Slightly more helpful error messages"),(0,a.kt)("li",{parentName:"ul"},"Uses a symbol-key on the query nodes to protect against an object accidentally being inserted verbatim and being treated as valid (because every Symbol is unique an attacker would need control of the code to get a reference to the Symbol in order to set it on an object (it cannot be serialised/deserialised via JSON or any other medium), and if the attacker has control of the code then you've already lost)"),(0,a.kt)("li",{parentName:"ul"},"Adds ",(0,a.kt)("inlineCode",{parentName:"li"},"sql.literal")," which is similar to ",(0,a.kt)("inlineCode",{parentName:"li"},"sql.value")," but when used with simple values can write the valid direct to the SQL statement. ",(0,a.kt)("strong",{parentName:"li"},"USE WITH CAUTION"),". The purpose for this is if you are using ",(0,a.kt)("em",{parentName:"li"},"trusted")," values (e.g. for the keys to ",(0,a.kt)("a",{parentName:"li",href:"https://www.postgresql.org/docs/9.6/static/functions-json.html"},(0,a.kt)("inlineCode",{parentName:"a"},"json_build_object(...)")),") then debugging your SQL becomes a lot easier because fewer placeholders are used.")))}d.isMDXComponent=!0}}]);