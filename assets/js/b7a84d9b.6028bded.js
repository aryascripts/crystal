"use strict";(self.webpackChunk_localrepo_postgraphile_website=self.webpackChunk_localrepo_postgraphile_website||[]).push([[5285],{30876:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>m});var r=t(2784);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var l=r.createContext({}),p=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},c=function(e){var n=p(e.components);return r.createElement(l.Provider,{value:n},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},g=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=p(t),g=i,m=d["".concat(l,".").concat(g)]||d[g]||u[g]||a;return t?r.createElement(m,s(s({ref:n},c),{},{components:t})):r.createElement(m,s({ref:n},c))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var a=t.length,s=new Array(a);s[0]=g;var o={};for(var l in n)hasOwnProperty.call(n,l)&&(o[l]=n[l]);o.originalType=e,o[d]="string"==typeof e?e:i,s[1]=o;for(var p=2;p<a;p++)s[p]=t[p];return r.createElement.apply(null,s)}return r.createElement.apply(null,t)}g.displayName="MDXCreateElement"},1401:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>p});var r=t(7896),i=(t(2784),t(30876));const a={layout:"page",path:"/postgraphile/postgresql-indexes/",title:"PostgreSQL indexes"},s=void 0,o={unversionedId:"postgresql-indexes",id:"postgresql-indexes",title:"PostgreSQL indexes",description:"It\u2019s important that your queries stay fast for your users, this section outlines",source:"@site/postgraphile/postgresql-indexes.md",sourceDirName:".",slug:"/postgresql-indexes",permalink:"/postgraphile/next/postgresql-indexes",draft:!1,editUrl:"https://github.com/graphile/crystal/tree/main/postgraphile/website/postgraphile/postgresql-indexes.md",tags:[],version:"current",frontMatter:{layout:"page",path:"/postgraphile/postgresql-indexes/",title:"PostgreSQL indexes"},sidebar:"docs",previous:{title:"Aggregates",permalink:"/postgraphile/next/aggregates"},next:{title:"Security",permalink:"/postgraphile/next/security"}},l={},p=[{value:"Advice - Foreign Key Indexes",id:"advice---foreign-key-indexes",level:3}],c={toc:p},d="wrapper";function u(e){let{components:n,...t}=e;return(0,i.kt)(d,(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"It\u2019s important that your queries stay fast for your users, this section outlines\nsome resources to help you optimize you queries with indexes."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Heroku\u2019s ",(0,i.kt)("a",{parentName:"p",href:"https://devcenter.heroku.com/articles/postgresql-indexes"},"Efficient Use of PostgreSQL Indexes")," outlines how to best use\nindexes to optimize you queries. The entire article is a helpful read, but if\nnothing else read the last section ",(0,i.kt)("a",{parentName:"p",href:"https://devcenter.heroku.com/articles/postgresql-indexes#managing-and-maintaining-indexes"},"Managing and Maintaining Indexes")," for a\nbetter understanding of how indexes work.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The PostgreSQL documentation has a great article describing the relationship\nbetween ",(0,i.kt)("a",{parentName:"p",href:"http://www.postgresql.org/docs/current/static/indexes-ordering.html"},"Indexes and ",(0,i.kt)("inlineCode",{parentName:"a"},"ORDER BY")),"."))),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"This article was originally written by\n",(0,i.kt)("a",{parentName:"em",href:"https://twitter.com/calebmer"},"Caleb Meredith"),".")),(0,i.kt)("h3",{id:"advice---foreign-key-indexes"},"Advice - Foreign Key Indexes"),(0,i.kt)("p",null,"Many people don't realise that when you create a ",(0,i.kt)("a",{parentName:"p",href:"./relations/"},"foreign key\nrelation"),', PostgreSQL does NOT automatically create an index on\nthe referencing column(s). That can mean that when you query based on that\nrelation, which PostGraphile does a lot when traversing relationships, it can\ninvolve a full table scan which is very expensive. By default, PostGraphile\nwill not add this "reverse lookup" field to the GraphQL schema unless there is\nan index on it for this reason (though you can force it with the ',(0,i.kt)("inlineCode",{parentName:"p"},"+select"),"\nbehavior on the foreign key constraint)."),(0,i.kt)("p",null,"Cameron Ellis has written a short article on\n",(0,i.kt)("a",{parentName:"p",href:"https://medium.com/@awesboss/how-to-find-missing-indexes-on-foreign-keys-2faffd7e6958"},"finding missing indexes on foreign keys"),"\nwhich utilises SQL similar to the following to automatically detect missing\nforeign key indexes:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"WITH indexed_tables AS (\n  select\n      ns.nspname,\n      t.relname as table_name,\n      i.relname as index_name,\n      array_to_string(array_agg(a.attname), ', ') as column_names,\n      ix.indrelid,\n      string_to_array(ix.indkey::text, ' ')::smallint[] as indkey\n  FROM pg_class i\n  JOIN pg_index ix ON i.OID = ix.indrelid\n  JOIN pg_class t ON ix.indrelid = t.oid\n  JOIN pg_namespace ns ON ns.oid = t.relnamespace\n  JOIN pg_attribute a ON a.attrelid = t.oid\n  where a.attnum = ANY(ix.indkey)\n  and t.relkind = 'r'\n  and nspname not in ('pg_catalog')\n  group by\n      ns.nspname,\n      t.relname,\n      i.relname,\n      ix.indrelid,\n      ix.indkey\n  order by\n      ns.nspname,\n      t.relname,\n      i.relname,\n      ix.indrelid,\n      ix.indkey\n)\nSELECT\n  conrelid::regclass\n  ,conname\n  ,reltuples::bigint\nFROM pg_constraint pgc\nJOIN pg_class ON (conrelid = pg_class.oid)\nWHERE contype = 'f'\nAND NOT EXISTS(\n  SELECT 1\n  FROM indexed_tables\n  WHERE indrelid = conrelid\n  AND conkey = indkey\n  OR (array_length(indkey, 1) > 1 AND indkey @> conkey)\n)\nORDER BY reltuples DESC;\n")),(0,i.kt)("p",null,"You should consider integrating something like this into your CI tests to ensure\nthat all your foreign keys are indexed."),(0,i.kt)("p",null,"Our ",(0,i.kt)("a",{parentName:"p",href:"https://pgrita.com"},"pgRITA.com")," tool will also help you spot this kind of\nissue and more; it has a free usage tier with some essentials and is also\nincluded in certain sponsorship tiers."))}u.isMDXComponent=!0}}]);